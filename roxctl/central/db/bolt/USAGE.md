# Using roxctl central db bolt

The main use-cases of using `roxctl central db bolt` are two-fold:
- Viewing / modifying contents for a specific bucket in a backup generated by `roxctl central backup`.
- Viewing / modifying contents for a specific bucket of a running instance of central (i.e. the contents of the volume within central).

Below are the steps to be executed for both different use-cases, as well as a general section about how to execute roxctl
in combination with the `roxctl central db bolt` commands within a docker container.

## Executing roxctl as docker image

Besides offering binaries for roxctl, a container image exists as well (i.e. `quay.io/stackrox-io/roxctl | quay.io/rhacs-eng/roxctl`).

If you want to run roxctl within the docker container, you have to ensure files you require (i.e. the `bolt.db`) file
are mounted properly within the container.

You can use the following which will run the image and mount the file correctly:
```bash
# Assuming you are in a current directory containing the bolt.db file:
ls .
... bolt.db

# Mount the current working directory into the container:
docker run -v "$(pwd)"/bolt.db:/bolt.db -it quay.io/stackrox-io/roxctl:3.73.x-212-g90c7061d65 central db bolt list -f /bolt.db
```

## Usage with a backup

Backups of the central DB are basically a .zip archive.

Within the archive, the following structure can be found:
```
|
|- rocks.db
|- bolt.db
|- migration_version.yaml
|- keys
    |- ca-key.pem
    |- ca.pem
    |- jwt-key.pem
```

The interesting file for the `roxctl central db bolt` command will be the `bolt.db` file, containing all the buckets stored
within bolt.

First and foremost, the `roxctl central db bolt list` command can be used to list the contents of the bucket.
The contents will be shown in different format (i.e. string, proto messages, hex values).
This gives flexibility to verify all entries, irrespective of whether they are malformed or not.

_Sample output of running the command:_
```bash
roxctl central db bolt list -f /path/to/bolt.db
Key io.stackrox.authz.group.574edb06-4a78-402a-bedd-4d8ce4038ae5
>>>	string value:

d
$d01d0881-81e3-468d-ad91-77f568943eb0"<io.stackrox.authz.group.574edb06-4a78-402a-bedd-4d8ce4038ae5Admin
>>>	proto message:
props: <
  id: "io.stackrox.authz.group.574edb06-4a78-402a-bedd-4d8ce4038ae5"
  auth_provider_id: "d01d0881-81e3-468d-ad91-77f568943eb0"
>
role_name: "Admin"

>>>	hex value:
0a640a2464303164303838312d383165332d343638642d616439312d373766353638393433656230223c696f2e737461636b726f782e617574687a2e67726f75702e35373465646230362d346137382d343032612d626564642d3464386365343033386165351a0541646d696e

```

When dealing with invalid entries inside a bucket, the command `roxctl central db bolt re-create` may be used.
Currently, it only supports re-creating the `groups` bucket.

When passing the `--dry-run` flag, all invalid entries will be printed, as well as the entries which will be included
within the newly created bucket:
_Sample output of running the command with the --dry-run flag:_
```bash
roxctl central db bolt re-create groups -f /path/to/bolt.db --dry-run
INFO:	The following entry would be added to the bucket:
(hex-format)
Key: 696f2e737461636b726f782e617574687a2e67726f75702e35373465646230362d346137382d343032612d626564642d346438636534303338616535
Value: 0a640a2464303164303838312d383165332d343638642d616439312d373766353638393433656230223c696f2e737461636b726f782e617574687a2e67726f75702e35373465646230362d346137382d343032612d626564642d3464386365343033386165351a0541646d696e
```

Without the dry-run flag, the bucket will be re-created, dropping all invalid entries.

## Usage with volumes

Since roxctl is available as a container image, it may also be used directly in conjunction with a deployment of central
to modify the volume in-place.

Ensuring this will not conflict with central itself, the image should be run as a init container.
The same options exist as listed previously in the [Usage with a backup](#Usage with a backup) section.

Depending on your use-case, the init container YAML would look as following:
_For listing the contents of a bucket:_
```yaml
      initContainers:
      - args:
        - central
        - db
        - bolt
        - list
        - -f
        - /var/lib/stackrox/current/stackrox.db
        command:
        - /roxctl
        image: quay.io/stackrox-io/roxctl:3.73.x-212-g90c7061d65
        imagePullPolicy: IfNotPresent
        name: roxctl
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/lib/stackrox
          name: stackrox-db
```

_For re-creating the contents of a bucket, dropping invalid entries:_
```yaml
      initContainers:
      - args:
        - central
        - db
        - bolt
        - re-create
        - groups
        - -f
        - /var/lib/stackrox/current/stackrox.db
        - --dry-run # This one is optional, and should be removed after the first successful execution.
        command:
        - /roxctl
        image: quay.io/stackrox-io/roxctl:3.73.x-212-g90c7061d65
        imagePullPolicy: IfNotPresent
        name: roxctl
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/lib/stackrox
          name: stackrox-db
```

Observing the logs of an init container can be done with:
```bash
kubectl logs -l app=central -c roxctl
```
