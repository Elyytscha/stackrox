syntax = "proto3";

option go_package = "storage";
option java_package = "io.stackrox.proto.storage";

import "google/protobuf/timestamp.proto";
import "protobuf/gogoproto/gogo.proto";

package storage;

enum ClusterType {
    GENERIC_CLUSTER          = 0;
    KUBERNETES_CLUSTER       = 1;
    OPENSHIFT_CLUSTER        = 2;
    reserved 3;
    DOCKER_EE_CLUSTER        = 4;
}

message GoogleProviderMetadata {
    string project      = 1;
    string cluster_name = 2;
}

message AWSProviderMetadata {
    string account_id = 1;
}

message AzureProviderMetadata {
    string subscription_id = 1;
}

message ProviderMetadata {
    string region = 1;
    string zone   = 2;

    oneof Provider {
        GoogleProviderMetadata google = 3;
        AWSProviderMetadata aws       = 4;
        AzureProviderMetadata azure   = 5;
    }

    bool verified = 15;
}

message OrchestratorMetadata {
    string                    version      = 1;
    google.protobuf.Timestamp build_date   = 2;
    repeated string           api_versions = 3;
}

enum CollectionMethod {
    UNSET_COLLECTION = 0;
    NO_COLLECTION    = 1;
    KERNEL_MODULE    = 2;
    EBPF             = 3;
}

message AdmissionControllerConfig {
    bool                  enabled                              = 1;
    int32                 timeout_seconds                      = 2;
    bool                  scan_inline                          = 3;
    bool                  disableBypass                        = 4;
}

message DynamicClusterConfig {
    AdmissionControllerConfig admission_controller_config = 1;
}

message Cluster {
    string                    id                          = 1 [(gogoproto.moretags) = "search:\"Cluster ID,hidden\""];
    string                    name                        = 2 [(gogoproto.moretags) = "search:\"Cluster\""];
    ClusterType               type                        = 3;
    string                    main_image                  = 4;
    string                    collector_image             = 16;
    string                    central_api_endpoint        = 5;
    reserved                                                6;
    bool                      runtime_support             = 7 [deprecated=true];
    string                    monitoring_endpoint         = 8;
    CollectionMethod          collection_method           = 17;

    reserved 9,10,11;

    ProviderMetadata          DEPRECATED_provider_metadata     = 12;
    bool                      admission_controller             = 13;
    OrchestratorMetadata      DEPRECATED_orchestrator_metadata = 14;

    ClusterStatus             status                      = 15;
    DynamicClusterConfig      dynamic_config              = 18;
}

message ClusterStatus {
    string                    sensor_version        = 1;
    google.protobuf.Timestamp last_contact          = 2;
    ProviderMetadata          provider_metadata     = 3;
    OrchestratorMetadata      orchestrator_metadata = 4;
}
