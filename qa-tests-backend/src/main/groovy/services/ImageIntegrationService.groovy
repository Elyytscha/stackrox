package services

import io.grpc.Status
import io.grpc.StatusRuntimeException
import io.stackrox.proto.api.v1.ImageIntegrationServiceGrpc
import io.stackrox.proto.api.v1.ImageIntegrationServiceOuterClass
import io.stackrox.proto.storage.ImageIntegrationOuterClass
import io.stackrox.proto.storage.ImageIntegrationOuterClass.ImageIntegrationCategory
import util.Env

import util.Timer

class ImageIntegrationService extends BaseService {
    static final private String AUTO_REGISTERED_STACKROX_SCANNER_INTEGRATION = "Stackrox Scanner"
    static final private String AUTO_REGISTERED_GCR_INTEGRATION = "Autogenerated https://us.gcr.io for cluster remote"

    static getImageIntegrationClient() {
        return ImageIntegrationServiceGrpc.newBlockingStub(getChannel())
    }

    static testImageIntegration(ImageIntegrationOuterClass.ImageIntegration integration) {
        try {
            getImageIntegrationClient().testImageIntegration(integration)
            return true
        } catch (Exception e) {
            println e.toString()
            return false
        }
    }

    static createImageIntegration(ImageIntegrationOuterClass.ImageIntegration integration,
                                  skipTestSideTest = false) {
        if (!skipTestSideTest) {
            Boolean tested = false
            Timer t = new Timer(15, 3)
            while (t.IsValid()) {
                try {
                    getImageIntegrationClient().testImageIntegration(integration)
                    println "Integration tested: ${integration.name}"
                    tested = true
                    break
                } catch (Exception e) {
                    println "Integration test failed: ${integration.name}: ${e.message}"
                }
            }

            if (!tested) {
                println "Integration test failed"
                return ""
            }
        }

        ImageIntegrationOuterClass.ImageIntegration createdIntegration
        Timer t = new Timer(15, 3)
        while (t.IsValid()) {
            try {
                createdIntegration =
                        getImageIntegrationClient().postImageIntegration(integration)
                println "Integration created: ${createdIntegration.name}: ${createdIntegration.id}"
                break
            } catch (Exception e) {
                println "Unable to create image integration ${integration.name}: ${e.message}"
            }
        }

        if (!createdIntegration || !createdIntegration.id) {
            println "Unable to create image integration"
            return ""
        }

        ImageIntegrationOuterClass.ImageIntegration foundIntegration
        t = new Timer(15, 3)
        while (t.IsValid()) {
            try {
                foundIntegration =
                    getImageIntegrationClient().getImageIntegration(getResourceByID(createdIntegration.id))
                if (foundIntegration) {
                    println "Integration found after creation: ${foundIntegration.name}: ${foundIntegration.id}"
                    return foundIntegration.id
                }
            } catch (Exception e) {
                println "Unable to find the created image integration ${integration.name}: ${e.message}"
            }
        }

        println "Unable to find the created image integration"
        return ""
    }

    static deleteImageIntegration(String integrationId) {
        try {
            getImageIntegrationClient().deleteImageIntegration(getResourceByID(integrationId))
        } catch (Exception e) {
            println "Failed to delete integration: ${e.toString()}"
            return false
        }
        try {
            ImageIntegrationOuterClass.ImageIntegration integration =
                    getImageIntegrationClient().getImageIntegration(getResourceByID(integrationId))
            while (integration) {
                sleep 2000
                integration = getImageIntegrationClient().getImageIntegration(getResourceByID(integrationId))
            }
        } catch (StatusRuntimeException e) {
            if (e.status.code == Status.Code.NOT_FOUND) {
                println "Image integration deleted: ${integrationId}"
                return true
            }
        }
    }

    static getImageIntegrations() {
        return getImageIntegrationClient().getImageIntegrations(
                ImageIntegrationServiceOuterClass.GetImageIntegrationsRequest.newBuilder().build()
        ).integrationsList
    }

    static getImageIntegrationByName(String name) {
        List<ImageIntegrationOuterClass.ImageIntegration> integrations = getImageIntegrations()
        def integrationId = integrations.find { it.name == name }?.id
        return integrationId ?
                getImageIntegrationClient().getImageIntegration(getResourceByID(integrationId)) :
                null
    }

    /*
        Helper functions to simplify creating known integrations
    */

    // For now, we delete the auto registered StackRox Scanner integration
    // since the QA tests are not stable when we run with them.
    // This function returns whether or not the integration was deleted.
    static boolean deleteAutoRegisteredStackRoxScannerIntegrationIfExists() {
        try {
            // The Stackrox Scanner integration is auto-added by the product,
            // so we first check whether it already exists.
            def scannerIntegrations = getImageIntegrationClient().getImageIntegrations(
                    ImageIntegrationServiceOuterClass.GetImageIntegrationsRequest.
                            newBuilder().
                            setName(AUTO_REGISTERED_STACKROX_SCANNER_INTEGRATION).
                            build()
            )
            if (scannerIntegrations.integrationsCount > 1) {
                throw new RuntimeException("UNEXPECTED: Got more than one scanner integration: ${scannerIntegrations}")
            }
            if (scannerIntegrations.integrationsCount == 0) {
                return false
            }
            def id = scannerIntegrations.getIntegrations(0).id
            // Delete
            getImageIntegrationClient().deleteImageIntegration(getResourceByID(id))
            return true
        } catch (Exception e) {
            println "Unable to delete existing Stackrox scanner integration: ${e.message}"
            // return false since we are not sure if the integration exists and failed to delete, or did not exist
            return false
        }
    }

    // This function adds the Stackrox scanner integration.
    // Currently, we do this if it was deleted by the test on setup,
    // so that the test leaves things in the same state after cleanup.
    static String addStackroxScannerIntegration() {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName(AUTO_REGISTERED_STACKROX_SCANNER_INTEGRATION)
                        .setType("clairify")
                        .addAllCategories([ImageIntegrationCategory.SCANNER])
                        .setClairify(ImageIntegrationOuterClass.ClairifyConfig.newBuilder()
                                .setEndpoint("https://scanner.stackrox:8080"))
                        .build()

        return createImageIntegration(integration)
    }

    static Boolean hasAnchoreDeployment() {
        return Env.get("ANCHORE_ENDPOINT") != null
    }

    static String addAnchoreScannerIntegration() {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName("anchore")
                        .setType("anchore")
                        .addAllCategories([ImageIntegrationCategory.SCANNER])
                        .setAnchore(ImageIntegrationOuterClass.AnchoreConfig.newBuilder()
                            .setUsername(Env.mustGet("ANCHORE_USERNAME"))
                            .setPassword(Env.mustGet("ANCHORE_PASSWORD"))
                            .setEndpoint(Env.mustGet("ANCHORE_ENDPOINT")))
                        .build()

        return createImageIntegration(integration)
    }

    static String addDockerTrustedRegistry(boolean includeScanner = true) {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName("dtr")
                        .setType("dtr")
                        .addAllCategories(getIntegrationCategories(includeScanner))
                        .setDtr(ImageIntegrationOuterClass.DTRConfig.newBuilder()
                                .setUsername("qa")
                                .setPassword(Env.get("DTR_REGISTRY_PASSWORD", ""))
                                .setEndpoint("https://apollo-dtr.rox.systems/"))
                        .build()

        return createImageIntegration(integration)
    }

    static addAzureRegistry() {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName("azure")
                        .setType("azure")
                        .addAllCategories([ImageIntegrationCategory.REGISTRY])
                        .setDocker(ImageIntegrationOuterClass.DockerConfig.newBuilder()
                                .setUsername("3e30919c-a552-4b1f-a67a-c68f8b32dad8")
                                .setPassword(Env.mustGet("AZURE_REGISTRY_PASSWORD"))
                                .setEndpoint("stackroxacr.azurecr.io"))
                        .build()

        return createImageIntegration(integration)
    }

    static String addGcrRegistry(
            String name = "gcr",
            String endpoint = "us.gcr.io",
            boolean includeScanner = true) {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName(name)
                        .setType("google")
                        .addAllCategories(getIntegrationCategories(includeScanner))
                        .setGoogle(ImageIntegrationOuterClass.GoogleConfig.newBuilder()
                                .setServiceAccount(Env.mustGet("GOOGLE_CREDENTIALS_GCR_SCANNER"))
                                .setEndpoint(endpoint)
                                .setProject("stackrox-ci"))
                        .build()

        return createImageIntegration(integration)
    }

    static String addGcrNoAccessRegistry(
            String name = "gcr-no-access",
            String endpoint = "us.gcr.io",
            boolean includeScanner = true) {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName(name)
                        .setType("google")
                        .addAllCategories(getIntegrationCategories(includeScanner))
                        .setGoogle(ImageIntegrationOuterClass.GoogleConfig.newBuilder()
                                .setServiceAccount(Env.mustGet("GOOGLE_CREDENTIALS_GCR_NO_ACCESS_KEY"))
                                .setEndpoint(endpoint)
                                .setProject("stackrox-ci"))
                        .setSkipTestIntegration(true)
                        .build()

        return createImageIntegration(integration, true)
    }

    static String handleUnreliableGCRAutoGenerate() {
        Boolean autogenerated = false
        Timer t = new Timer(10, 6)
        while (!autogenerated && t.IsValid()) {
            autogenerated = getImageIntegrations().any
                    { it.name =~ /^Autogenerated https:\/\/us.gcr.io/ }
        }

        if (autogenerated) {
            println "A GCR image integration was auto-generated. Nothing to do here."
            return
        }

        println "A GCR image integration was not auto-generated. One will be manually created for test."

        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName("Autogenerated https://us.gcr.io for test")
                        .setType("docker")
                        .addCategories(ImageIntegrationCategory.REGISTRY)
                        .setDocker(ImageIntegrationOuterClass.DockerConfig.newBuilder()
                                .setEndpoint("https://us.gcr.io")
                                .setUsername("_json_key")
                                .setPassword(Env.mustGet("GOOGLE_CREDENTIALS_GCR_SCANNER"))
                                .setInsecure(false))
                        .setAutogenerated(true)
                        .setSkipTestIntegration(false)
                        .build()

        return createImageIntegration(integration)
    }

    static boolean deleteAutoRegisteredGCRIntegrationIfExists() {
        ImageIntegrationOuterClass.ImageIntegration integration = getImageIntegrations().find
                { it.name == AUTO_REGISTERED_GCR_INTEGRATION }
        if (integration) {
            deleteImageIntegration(integration.getId())
        }
        else {
            println "There is no auto-registered GCR integration to delete"
        }
    }

    static String addDefaultQuayRegistry(
            String name = "quay",
            String endpoint = "quay.io",
            boolean includeScanner = true,
            boolean insecure = false) {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName(name)
                        .setType("quay")
                        .addAllCategories(getIntegrationCategories(includeScanner))
                        .setQuay(ImageIntegrationOuterClass.QuayConfig.newBuilder()
                                .setEndpoint(endpoint)
                                .setOauthToken(Env.mustGet("QUAY_BEARER_TOKEN"))
                                .setInsecure(insecure))
                        .build()

        return createImageIntegration(integration)
    }

    static String addDuplicateQuayRegistry(boolean includeScanner = true, boolean insecure = false) {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName("quay-duplicate")
                        .setType("quay")
                        .addAllCategories(getIntegrationCategories(includeScanner))
                        .setQuay(ImageIntegrationOuterClass.QuayConfig.newBuilder()
                        .setEndpoint("quay.io")
                        .setOauthToken(Env.mustGet("QUAY_BEARER_TOKEN"))
                        .setInsecure(insecure))
                        .build()

        return createImageIntegration(integration)
    }

    static String addSecondaryQuayRegistry(boolean includeScanner = true, boolean insecure = false) {
        ImageIntegrationOuterClass.ImageIntegration integration =
                ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                        .setName("quay-secondary")
                        .setType("quay")
                        .addAllCategories(getIntegrationCategories(includeScanner))
                        .setQuay(ImageIntegrationOuterClass.QuayConfig.newBuilder()
                        .setEndpoint("quay.io")
                        .setOauthToken(Env.mustGet("QUAY_SECONDARY_BEARER_TOKEN"))
                        .setInsecure(insecure))
                        .build()

        return createImageIntegration(integration)
    }

    static ImageIntegrationOuterClass.ImageIntegration getECRIntegrationConfig(
            String name,
            String registryID = Env.mustGetAWSECRRegistryID(),
            String registryRegion = Env.mustGetAWSECRRegistryRegion(),
            String endpoint = "",
            String accessKeyId = Env.mustGetAWSAccessKeyID(),
            String accessKey = Env.mustGetAWSSecretAccessKey()) {
        return ImageIntegrationOuterClass.ImageIntegration.newBuilder()
                .setName(name)
                .setType("ecr")
                .addAllCategories([ImageIntegrationCategory.REGISTRY])
                .setEcr(ImageIntegrationOuterClass.ECRConfig.newBuilder()
                        .setRegistryId(registryID)
                        .setRegion(registryRegion)
                        .setEndpoint(endpoint)
                        .setAccessKeyId(accessKeyId)
                        .setSecretAccessKey(accessKey)
                )
                .build()
    }

    static getIntegrationCategories(boolean includeScanner) {
        return includeScanner ?
                [ImageIntegrationCategory.REGISTRY, ImageIntegrationCategory.SCANNER] :
                [ImageIntegrationCategory.REGISTRY]
    }
}
