package messagestream

import (
	"io"

	"github.com/gogo/protobuf/proto"
	"github.com/stackrox/rox/generated/internalapi/central"
)

type wrap struct {
	grpcStream central.SensorService_CommunicateClient
}

func (w wrap) Send(msg *central.MsgFromSensor) error {
	return w.grpcStream.Send(msg)
}

// preserializedProtoMessage is a proto.Message that returns a static byte buffer for marshaling.
type preserializedProtoMessage struct {
	proto.Message
	serialized []byte
}

func (m preserializedProtoMessage) Marshal() ([]byte, error) {
	return m.serialized, nil
}

func (w wrap) SendRaw(msg *central.MsgFromSensor, raw []byte) error {
	err := w.grpcStream.SendMsg(preserializedProtoMessage{Message: msg, serialized: raw})
	if err == nil || err == io.EOF {
		return err // no error or server-generated error
	}
	// otherwise, assume error is generated by the client, so fall back to normal Send method.
	return w.grpcStream.Send(msg)
}

// Wrap wraps a GRPC Communicate stream into a SensorMessageStream.
func Wrap(grpcStream central.SensorService_CommunicateClient) SensorMessageStream {
	return wrap{grpcStream: grpcStream}
}
